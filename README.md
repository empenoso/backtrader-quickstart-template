# Модульный фреймворк для бэктестинга на Backtrader

Это универсальный и гибкий Python-фреймворк, созданный на основе библиотеки **Backtrader**. Он предназначен для систематического тестирования, оптимизации и анализа торговых стратегий. Архитектура проекта позволяет легко добавлять новые стратегии, переключаться между ними и получать подробные, стандартизированные отчеты.

## 🚀 Ключевые возможности

*   **Модульная структура**: Каждая торговая стратегия находится в отдельном файле. Просто добавьте новый файл в папку `strategies`, и он будет автоматически обнаружен системой.
*   **Полная инкапсуляция стратегии**: Все ключевые параметры (список тикеров, начальный капитал, комиссия, параметры для оптимизации) настраиваются непосредственно внутри файла стратегии.
*   **Централизованное управление**: В `main.py` находится простая "панель управления" для выбора активной стратегии, режима работы и периода тестирования.
*   **Два режима работы**:
    *   `BACKTEST`: Глубокое тестирование одной стратегии с конкретными параметрами.
    *   `OPTIMIZATION`: Поиск лучших параметров для стратегии с построением наглядной тепловой карты.
*   **Продвинутая отчетность**:
    *   **Для бэктеста**: Автоматическая генерация текстового отчета с ключевыми метриками (Profit Factor, Sortino Ratio, Max Drawdown и др.).
    *   **Для оптимизации**: Создание тепловой карты по двум параметрам для визуального анализа и избежания переоптимизации, а также детального текстового отчета.
*   **Гибкая работа с данными**: Поддержка исторических данных в CSV-формате с возможностью указания точного временного диапазона для теста.
*   **Готовность к Live Trading**: В структуру заложена возможность подключения к брокеру (на примере Tinkoff) для реальной торговли, которую можно легко активировать.

## 📂 Структура проекта

```
.
├── data-connector/
│   └── Data/
│       └── Tinkoff/
│           └── TQBR.SBER_D1.txt      # Пример файла с историческими данными
├── reports/                          # Папка для сохранения отчетов и графиков
├── strategies/
│   ├── __init__.py                 # Авто-загрузчик стратегий
│   ├── base_strategy.py            # Базовый класс-шаблон для всех стратегий
│   └── sma_cross_strategy.py       # Пример готовой торговой стратегии
├── utils/
│   ├── custom_csv.py               # Загрузчик для CSV данных кастомного формата
│   ├── report_generator.py         # Модуль генерации отчетов и тепловых карт
│   └── sortino_analyzer.py         # Анализатор для расчета коэффициента Сортино
├── main.py                           # Главный файл для запуска и конфигурации
└── requirements.txt                  # Список зависимостей
```

## 🛠️ Установка и настройка

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/your-username/your-repo-name.git
    cd your-repo-name
    ```

2.  **Создайте и активируйте виртуальное окружение (рекомендуется):**
    ```bash
    python -m venv venv
    # Windows
    venv\Scripts\activate
    # macOS / Linux
    source venv/bin/activate
    ```

3.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```

## 📈 Как использовать

### Шаг 1: Подготовьте данные

Поместите ваши исторические данные в формате `.txt` или `.csv` в папку `data-connector/Data/Tinkoff/`. Фреймворк ожидает следующий формат данных с разделителем-табуляцией:

**Формат файла `TQBR.ABIO_D1.txt`:**
```
datetime	open	high	low	close	volume
07.03.2018 00:00	10.3	10.3	9.08	9.68	30360
09.03.2018 00:00	9.74	10.08	9.56	9.9	6720
...
```
Если ваш формат отличается, адаптируйте класс `CustomCSVData` в файле `utils/custom_csv.py`.

### Шаг 2: Создайте свою стратегию

1.  Перейдите в папку `strategies`.
2.  Создайте новый Python-файл, например, `my_strategy.py`.
3.  Внутри файла создайте класс, унаследованный от `BaseStrategy`, и определите его логику и параметры.

**Пример `strategies/my_strategy.py`:**
```python
from .base_strategy import BaseStrategy
import backtrader as bt

class MyStrategy(BaseStrategy):
    # 1. Конфигурация, специфичная для этой стратегии
    tickers = ['TQBR.SBER_D1.txt', 'TQBR.GAZP_D1.txt']  # Активы для теста
    start_cash = 1_000_000.0  # Начальный капитал
    commission = 0.001       # Комиссия 0.1%

    # 2. Параметры для одиночного бэктеста
    params = (
        ('exit_period', 20),
    )

    # 3. Параметры для оптимизации (РОВНО ДВА для тепловой карты)
    opt_params = {
        'fast_ma': range(5, 15),
        'slow_ma': range(20, 50)
    }

    def __init__(self):
        super().__init__()
        # 4. Ваша логика инициализации (например, индикаторы)
        self.fast_ma = bt.indicators.SimpleMovingAverage(self.data.close, period=self.opt_params['fast_ma'])
        self.slow_ma = bt.indicators.SimpleMovingAverage(self.data.close, period=self.opt_params['slow_ma'])

    def next(self):
        # 5. Ваша торговая логика
        if self.fast_ma > self.slow_ma and not self.position:
            self.buy()
        elif self.fast_ma < self.slow_ma and self.position:
            self.sell()
```

### Шаг 3: Настройте и запустите `main.py`

Откройте файл `main.py` и отредактируйте "панель управления":

```python
# ======================================================================================
# --- ГЛАВНАЯ ПАНЕЛЬ УПРАВЛЕНИЯ ---
# ======================================================================================

# 1. ВЫБЕРИТЕ РЕЖИМ: 'BACKTEST' или 'OPTIMIZATION'
MODE = 'BACKTEST'

# 2. ВЫБЕРИТЕ СТРАТЕГИЮ из загруженных (см. вывод в консоли при запуске)
#    Имя должно точно совпадать с именем класса стратегии.
STRATEGY_TO_RUN = 'SmaCrossStrategy' 

# 3. НАСТРОЙКИ ПЕРИОДА ТЕСТИРОВАНИЯ
FROM_DATE = datetime.datetime(2020, 1, 1)
TO_DATE = datetime.datetime(2023, 12, 31)

# 4. НАСТРОЙКИ LIVE TRADING (ЕСЛИ НУЖНО)
LIVE_TRADING = False
# ...
```

После настройки просто запустите скрипт:
```bash
python main.py
```

## 📄 Результаты и отчеты

Все результаты будут сохранены в папку `reports`.

### Отчет по бэктесту (`BACKTEST`)

Будет создан текстовый файл с подробной статистикой.

*   **Имя файла:** `reports/SmaCrossStrategy_test_2024-05-20_15-30_20200101-20231231.txt`
*   **Содержимое:**
    ```
    --- ОТЧЕТ ПО БЭКТЕСТУ СТРАТЕГИИ: SmaCrossStrategy ---
    Период тестирования: с 01.01.2020 по 31.12.2023
    --- РЕЗУЛЬТАТЫ ---
    Итоговая прибыль/убыток: 150 234.50 [15.02%]
    Доходность (годовых): 4.88%
    Результат 'Купил и держал': 120 110.00 [12.01%]
    Максимальная просадка: -85 432.10 [-8.54%]
    Всего сделок: 42
    Процент прибыльных сделок: 45.24%
    Фактор прибыли: 1.85
    Коэффициент Сортино: 0.98
    --------------------------------------------------
    ```

### Отчеты по оптимизации (`OPTIMIZATION`)

Будут созданы два файла:

1.  **Текстовый отчет** со всеми комбинациями параметров.
    *   **Имя файла:** `reports/SmaCrossStrategy_opt_2024-05-20_15-30_20200101-20231231.txt`

2.  **Тепловая карта** для визуального анализа.
    *   **Имя файла:** `reports/SmaCrossStrategy_opt_heatmap_TQBR.SBER_D1_2024-05-20_15-30_20200101-20231231.png`
    *   **Описание:** На графике по осям X и Y отложены значения двух оптимизируемых параметров. Цвет ячейки и число в ней показывают **фактор прибыли** для данной комбинации. Это позволяет быстро найти наиболее стабильные и прибыльные зоны параметров.

## 🤖 Подключение к реальной торговле

Фреймворк имеет заготовку для подключения к реальному счету через API.

1.  Установите необходимую библиотеку (например, `backtrader-tinkoff`).
2.  В `main.py` установите `LIVE_TRADING = True`.
3.  Укажите ваш API-токен в `TINKOFF_TOKEN`.
4.  Раскомментируйте и адаптируйте соответствующий блок кода в `main.py`.

## 🤝 Вклад и развитие

Не стесняйтесь форкать репозиторий, создавать Issues и присылать Pull Requests. Возможные направления для развития:
*   Добавление новых кастомных анализаторов.
*   Интеграция с другими брокерами.
*   Расширение функционала генерации отчетов (например, построение графика эквити).

## 📄 Лицензия

Этот проект распространяется под лицензией MIT. Подробности см. в файле `LICENSE`.
