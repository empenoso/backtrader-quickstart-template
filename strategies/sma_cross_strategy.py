# strategies/sma_cross_strategy.py

# üìà –°—Ç—Ä–∞—Ç–µ–≥–∏—è "–ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å–∫–æ–ª—å–∑—è—â–∏—Ö —Å—Ä–µ–¥–Ω–∏—Ö" üìà
#
# –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ç–æ—Ä–≥–æ–≤—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é, –æ—Å–Ω–æ–≤–∞–Ω–Ω—É—é –Ω–∞ –ø–æ–ø—É–ª—è—Ä–Ω–æ–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–µ
# "–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å–∫–æ–ª—å–∑—è—â–∏—Ö —Å—Ä–µ–¥–Ω–∏—Ö" (SMA Crossover). –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≥—Ä–∞—Ñ–∏–∫ —Ü–µ–Ω—ã –∏ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç
# —Ä–µ—à–µ–Ω–∏—è –æ –ø–æ–∫—É–ø–∫–µ –∏–ª–∏ –ø—Ä–æ–¥–∞–∂–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –¥–≤—É—Ö –ª–∏–Ω–∏–π: –±—ã—Å—Ç—Ä–æ–π –∏ –º–µ–¥–ª–µ–Ω–Ω–æ–π —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã.
#
# –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:
# - –†–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ–ª–Ω—É—é —Ç–æ—Ä–≥–æ–≤—É—é –ª–æ–≥–∏–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –¥–≤—É—Ö SMA.
# - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: —Å–ø–∏—Å–æ–∫ –∞–∫—Ü–∏–π –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏, –Ω–∞—á–∞–ª—å–Ω—ã–π –∫–∞–ø–∏—Ç–∞–ª.
# - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–≤–µ —Å–∫–æ–ª—å–∑—è—â–∏–µ —Å—Ä–µ–¥–Ω–∏–µ: –±—ã—Å—Ç—Ä—É—é (–∫–æ—Ä–æ—Ç–∫–∏–π –ø–µ—Ä–∏–æ–¥) –∏ –º–µ–¥–ª–µ–Ω–Ω—É—é (–¥–ª–∏–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥).
# - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∏–≥–Ω–∞–ª –Ω–∞ –ü–û–ö–£–ü–ö–£, –∫–æ–≥–¥–∞ –±—ã—Å—Ç—Ä–∞—è –ª–∏–Ω–∏—è –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω—É—é —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö ("–∑–æ–ª–æ—Ç–æ–π –∫—Ä–µ—Å—Ç").
# - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∏–≥–Ω–∞–ª –Ω–∞ –ü–†–û–î–ê–ñ–£ (–∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–∏), –∫–æ–≥–¥–∞ –±—ã—Å—Ç—Ä–∞—è –ª–∏–Ω–∏—è –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω—É—é —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑ ("–∫—Ä–µ—Å—Ç —Å–º–µ—Ä—Ç–∏").
# - –°–æ–¥–µ—Ä–∂–∏—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –∏ –¥–∏–∞–ø–∞–∑–æ–Ω—ã –¥–ª—è —Ä–µ–∂–∏–º–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–ø–æ–∏—Å–∫–∞ –ª—É—á—à–∏—Ö –ø–µ—Ä–∏–æ–¥–æ–≤).
#
# –ê–≤—Ç–æ—Ä: –ú–∏—Ö–∞–∏–ª –®–∞—Ä–¥–∏–Ω https://shardin.name/
# –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: 10.08.2025
# –í–µ—Ä—Å–∏—è: 1.0
# –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –≤—Å–µ–≥–¥–∞ –∑–¥–µ—Å—å: https://github.com/empenoso/backtrader-quickstart-template/
#
# –ò–º—è —ç—Ç–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ ('SmaCrossStrategy') –Ω—É–∂–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å –≤ main.py –¥–ª—è –µ–µ –∑–∞–ø—É—Å–∫–∞.
#

import backtrader as bt
from .base_strategy import BaseStrategy

class SmaCrossStrategy(BaseStrategy):
    # --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
    tickers = ['TQBR.SBER_D1.txt']  # –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞ –°–±–µ—Ä–µ
    start_cash = 500_000.0
    commission = 0.001

    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –±—ç–∫—Ç–µ—Å—Ç–∞
    params = (
        ('fast_ma', 10),
        ('slow_ma', 50),
    )
    
    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (—Ä–æ–≤–Ω–æ –¥–≤–∞!)
    opt_params = {
        'fast_ma': range(5, 21, 5),   # –æ—Ç 5 –¥–æ 20 —Å —à–∞–≥–æ–º 5
        'slow_ma': range(30, 61, 10) # –æ—Ç 30 –¥–æ 60 —Å —à–∞–≥–æ–º 10
    }

    def __init__(self):
        super().__init__()
        self.crossover = {}
        for d in self.datas:
            fast_sma = bt.indicators.SimpleMovingAverage(d.close, period=self.p.fast_ma)
            slow_sma = bt.indicators.SimpleMovingAverage(d.close, period=self.p.slow_ma)
            self.crossover[d._name] = bt.indicators.CrossOver(fast_sma, slow_sma)

    def next(self):
        for d in self.datas:
            pos = self.getposition(d)
            if not pos:  # –ï—Å–ª–∏ –Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏
                if self.crossover[d._name][0] > 0:  # –ë—ã—Å—Ç—Ä–∞—è MA –ø–µ—Ä–µ—Å–µ–∫–ª–∞ –º–µ–¥–ª–µ–Ω–Ω—É—é —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö
                    self.buy(data=d, size=100)
            else:  # –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç–∞—è –ø–æ–∑–∏—Ü–∏—è
                if self.crossover[d._name][0] < 0:  # –ë—ã—Å—Ç—Ä–∞—è MA –ø–µ—Ä–µ—Å–µ–∫–ª–∞ –º–µ–¥–ª–µ–Ω–Ω—É—é —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑
                    self.close(data=d)